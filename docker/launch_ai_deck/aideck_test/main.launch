<launch>
  <node pkg="crazyflie_driver" type="crazyflie_server" name="crazyflie_server" output="screen"/>
  <arg name="use_mocap_for_state_estimation" default="False"/>
  <arg name="use_world_frame" default="False"/>
  <arg name="ground_truth" default="1"/>
  <arg name="inference" default="1"/>
  <arg name="streaming" default="1"/>
  <arg name="rate" default="30"/>
  <arg name="filter" default="0"/>
  <arg name="onboard" default="1"/>
  <arg name="offboard" default="0"/>
  <arg name="stream_inference" default="1"/>

  <arg name="eta" default="1.0"/>
  <arg name="max_angular_speed" default="2.0"/>
  <arg name="max_speed" default="1.2"/>
  <arg name="max_vertical_speed" default="0.8"/>
  <arg name="relative_altitude" default="0"/>
  <arg name="target_range" default="1.3"/>
  <arg name="target_altitude" default="$(optenv ALT 1.4)"/>
  <arg name="prefix" default="$(optenv PREFIX test)"/>

  <arg name="takeoff_altitude" default="1.0"/>
  <arg name="bag" default="1"/>
  <!-- in degrees  -->
  <!-- firmware default is 25, set it lower to increase stability -->
  <arg name="P_pitch" default="18"/>
  <!-- in degrees  -->
  <!-- firmware default is 20, we set to 12 because the models are [fake] pitch augemented in [-13, 13] -->
  <arg name="max_pitch" default="12"/>
  <!-- in 1/seconds  -->
  <!-- firmware default is 6, set it lower to increase stability -->
  <arg name="P_pitch_rate" default="6"/>
  <!-- stability: slope * rad(P_pitch) * P_pitch_rate < 1 -->

  <arg name="_front_net_param" value="$(eval arg('offboard') == 1 or arg('stream_inference') == 1)"/>

  <arg name="_optitrack" value="$(eval arg('use_world_frame') == 1 or arg('ground_truth') == 1)"/>

  <include file="$(find drone_arena)/launch/test_optitrack_odom.launch" if="$(arg _optitrack)"/>

  <include file="$(find crazyflie_description)/launch/model.launch">
    <arg name="name" value="cf"/>
    <arg name="camera" value="true"/>
  </include>

  <node clear_params="true" name='supervisor' pkg='drone_arena' type='cf_supervisor.py' output="screen" ns="cf">
    <param name='name' value='cf'/>
    <rosparam subst_value="true" param="">
      radio:
        id: 0
        channel: 100
        bandwidth : 2M
      params: []
      crazyflies:
        -
          id: 6
          front_net: $(arg _front_net_param)
          front_net_frame: base_stabilized
          front_net_rate: $(arg rate)
          params:
            kalman/thetapix: 3.75
            stabilizer/controller: 1
            stabilizer/estimator: 2
            aideck_HIMAX/fps: $(arg rate)
            aideck_inference/active: $(arg inference)
            aideck_stream/on: $(arg streaming)
            frontnet/enable_control: 0
            frontnet/max_speed: $(arg max_speed)
            frontnet/max_ang_speed: $(arg max_angular_speed)
            frontnet/max_vert_speed: $(arg max_vertical_speed)
            frontnet/eta: $(arg eta)
            frontnet/rel_altitude: $(arg relative_altitude)
            frontnet/distance: $(arg target_range)
            frontnet/altitude: $(arg target_altitude)
            velCtlPid/vxKp: $(arg P_pitch)
            velCtlPid/vyKp: $(arg P_pitch)
            posCtlPid/rpLimit: $(arg max_pitch)
            pid_attitude/pitch_kp: $(arg P_pitch_rate)
          topics:
            frontnet_state:
              period: 500
              variables: [frontnet.control_active, frontnet.update_frequency]
        -
          id: 7
          front_net: $(arg _front_net_param)
          front_net_frame: base_stabilized
          front_net_rate: $(arg rate)
          params:
            kalman/thetapix: 3.75
            stabilizer/controller: 1
            stabilizer/estimator: 2
            aideck_HIMAX/fps: $(arg rate)
            aideck_inference/active: $(arg inference)
            aideck_stream/on: $(arg streaming)
            frontnet/enable_control: 0
            frontnet/max_speed: $(arg max_speed)
            frontnet/max_ang_speed: $(arg max_angular_speed)
            frontnet/max_vert_speed: $(arg max_vertical_speed)
            frontnet/eta: $(arg eta)
            frontnet/rel_altitude: $(arg relative_altitude)
            frontnet/distance: $(arg target_range)
            frontnet/altitude: $(arg target_altitude)
            velCtlPid/vxKp: $(arg P_pitch)
            velCtlPid/vyKp: $(arg P_pitch)
            posCtlPid/rpLimit: $(arg max_pitch)
            pid_attitude/pitch_kp: $(arg P_pitch_rate)
          topics:
            frontnet_state:
              period: 500
              variables: [frontnet.control_active, frontnet.update_frequency]
    </rosparam>
  </node>

  <node name='frontnet_monitor' pkg='drone_arena' type='cf_frontnet_monitor.py' output="screen" ns="cf" if="$(arg onboard)"/>

  <group ns="cf" if="$(arg offboard)">

    <node name="pose2odom" pkg="drone_arena" type="pose2odom.py" output="screen"  unless="$(arg filter)">
      <remap from="pose" to="head"/>
      <remap from="odom" to="head_odom"/>
      <param name="theta" value="3.14159265"/>
    </node>

    <node name="prediction2odom" pkg="drone_arena" type="front_net2odom_kalman.py" output="screen" if="$(arg filter)">
      <remap from="prediction" to="output"/>
      <remap from="filtered_odom" to="head_odom"/>
    </node>

  </group>

  <node pkg="drone_arena" type="cf_controller.py" name="fence_controller" output="screen" ns="cf">
    <!-- <param name="mocap_pose" value="/optitrack/cf" if="$(arg use_mocap_for_state_estimation)"/> -->
    <param name="use_mocap_z" value="False"/>
    <param name="frame_id" value="$(eval 'World' if arg('use_world_frame') else 'cf/odom')"/>
    <remap from="odom" to="mocap_odom" if="$(arg use_world_frame)"/>
    <remap from="cf_odom" to="odom"/>
    <param name="enable_fence" value="True"/>
    <param name="publish_target" value="False"/>
    <param name="publish_body_vel" value="True"/>
    <param name="publish_cmd" value="False"/>
    <param name="teleop_mode" value="1"/>
    <param name="max_speed" value="$(arg max_speed)"/>
    <param name="max_vertical_speed" value="$(arg max_vertical_speed)"/>
    <param name="max_angular_speed" value="$(arg max_angular_speed)"/>
    <param name="tau" value="0.5"/>
    <param name="eta" value="$(arg eta)"/>
    <param name="delay" value="0"/>
    <param name="joy_set_teleop_mode" value="true"/>
    <param name="max_safe_angle" value="0.75"/>
    <param name="takeoff_altitude" value="$(arg takeoff_altitude)"/>
    <param name="land_at_altitude" value="false"/>
    <param name="track_altitude" value="$(arg target_altitude)"/>
    <param name="track_altitude_as_relative" value="$(eval arg('relative_altitude') > 0)"/>
    <param name="track_relative_altitude" value="$(arg target_altitude)"/>
    <param name="track_distance" value="$(arg target_range)"/>
    <rosparam param="pos_bounds">
      - [-100, 100]
      - [-100, 100]
      - [0.25, 2]
    </rosparam>
  </node>

  <include file="$(find drone_arena)/launch/joy_teleop.launch">
    <arg name="teleop_config" default="$(find drone_arena)/config/_joypad.yaml"/>
    <arg name="namespace" value="cf"/>
    <arg name="joy_dev" value="/dev/input/js0"/>
  </include>

  <node pkg="drone_arena" type="cf_led.py" name="blinkstick" output="screen" ns="cf">
    <param name="leds" value="8"/>
    <param name="max_intensity" value="100"/>
    <param name="ns" value="cf"/>
  </node>

  <group if="$(arg ground_truth)">

    <node clear_params="true" pkg="drone_arena" type="frontnet_gt.py" name="frontnet_gt" output="screen" ns="cf">
      <param name="reference" value="cf/base_stabilized"/>
      <param name="object" value="head"/>
      <param name="period" value="$(eval 1/arg('rate'))"/>
    </node>
  </group>

  <node pkg="rosbag" type="record" name="rosbag_record" args="record -a -o $(find drone_arena)/bags/$(arg prefix)" if="$(arg bag)"/>

</launch>
